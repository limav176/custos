version: 2

models:
  - name: datadog_costs_month_usage
    meta:
      domain: custos_cloud
      layer: gold
      schema: custos_cloud_gold
      owner: observability-platform@willbank.com.br
      openmetadata:
        tags: [
          'classificacao_da_informacao.publico'
        ]
        tier: 'Tier.Tier2'

    description: |
      **Propósito:**
      Consolidar e agregar todos os custos de uso direto (`usage`) do Datadog em uma visão mensal. Esta tabela serve como a fonte de verdade para os gastos diretos de cada Círculo com os produtos Datadog.

      **Escopo e Lógica:**
      A tabela é um modelo de agregação simples.
      - **Fonte de Dados:**
        - `silver.datadog_costs_usage`: Contém os dados de custo de uso brutos do Datadog.
      - **Lógica Principal:**
        - A query agrupa os registros por todas as dimensões disponíveis (`start_date`, `service`, `circle_id`, `product_name`, etc.).
        - O custo (`cost`) é agregado usando `SUM()`.
        - A coluna `product_name` é duplicada como `original_product_name` para preservar o nome original.
      - Esta tabela é uma entrada fundamental para outros modelos, pois seus resultados são usados para calcular as taxas de rateio na tabela `datadog_costs_month_shared`.

      **Audiência:**
      Engenheiros de FinOps e líderes de Círculos que precisam analisar os custos diretos de uso do Datadog, e também para outros modelos de dbt que dependem desses dados.

      **Processo:**
      A tabela é reconstruída diariamente, agregando os custos do mês corrente.

      **Recorrência:**
      Diária.

    tags: [gold, will, custos_cloud]

    columns:
      - name: start_date
        description: "Primeiro dia do mês de referência para o custo. A agregação é feita com base neste campo. Proveniente da fonte `datadog_costs_usage`."
      - name: service
        description: "Nome do serviço ou time interno associado ao custo. Proveniente da fonte `datadog_costs_usage`."
      - name: circle_id
        description: "ID do Círculo (time) associado ao custo. Proveniente da fonte `datadog_costs_usage`."
      - name: circle_type
        description: "Tipo do Círculo (ex. 'stream_aligned'). Proveniente da fonte `datadog_costs_usage`."
      - name: original_product_name
        description: "Nome original do produto Datadog, preservado da fonte `product_name`. Usado para referência."
      - name: product_name
        description: "Nome do produto Datadog. Proveniente da fonte `datadog_costs_usage`."
      - name: product_group
        description: "Agrupamento de produtos de alto nível (ex. 'Infrastructure'). Proveniente da fonte `datadog_costs_usage`."
      - name: billing_type
        description: "Tipo de faturamento (ex. 'on-demand'). Proveniente da fonte `datadog_costs_usage`."
      - name: invoice_status
        description: "Status da fatura da qual o custo foi extraído. Proveniente da fonte `datadog_costs_usage`."
      - name: cost
        description: "Valor monetário mensal agregado para o custo de uso direto. Calculado como `SUM(cost)` sobre a fonte."
