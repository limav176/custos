version: 2

models:
  - name: all_product_costs_by_day
    description: >
      **Propósito:** Unificar todos os custos de nuvem (AWS, EKS, MongoDB Atlas, Datadog) em uma única tabela, servindo como a fonte de verdade centralizada para análises de custo em toda a empresa.
      **Escopo:** A tabela consolida dados de cinco fontes de custo distintas (`aws_eks_costs_day_usage`, `aws_costs_day_usage`, `aws_costs_day_untagged`, `mongodb_atlas_costs_day_usage`, `datadog_costs_month`) em uma granularidade diária.
      **Audiência:** Engenheiros de FinOps, líderes de Círculos e qualquer pessoa que precise de uma visão consolidada e detalhada dos custos de nuvem.
      **Processo:** A query usa uma operação `UNION ALL` para combinar as cinco fontes de dados. Para cada fonte, ela mapeia os campos específicos para um esquema comum e padronizado. Por exemplo, `namespace` (EKS) e `cluster_name` (MongoDB) são normalizados na coluna `resource_id`. Os custos são então agrupados por todas as dimensões para criar uma linha única para cada combinação.
      **Recorrência de atualização:** Diária.

    meta:
      domain: custos_cloud
      layer: gold
      schema: custos_cloud_gold
      owner: observability-platform@willbank.com.br
      openmetadata:
        tags: ['classificacao_da_informacao.publico']
        tier: 'Tier.Tier2'

    tags: 
      - "camada:gold"
      - "dominio:custos_cloud"
      - "finalidade:agregacao_de_custos"
      - "provedor:aws"
      - "provedor:eks"
      - "provedor:mongodb_atlas"
      - "provedor:datadog"
      - "granularidade:diaria"

    columns:
      - name: start_date
        description: "Data de referência em que o custo foi incorrido. Para fontes diárias, provém da coluna `start_date`; para a fonte mensal do Datadog, provém da coluna `month`."
      - name: provider
        description: "Identifica a plataforma que originou o custo. É um valor fixo atribuído para cada fonte: 'kubernetes', 'aws', 'mongodb' ou 'datadog'."
      - name: account_name
        description: "Nome da conta associada ao custo. Para AWS, é o nome da conta original. Para MongoDB e Datadog, é fixado como 'mongodb' e 'datadog' para padronização."
      - name: circle_id
        description: "Identificador do Círculo (time) ao qual o custo foi atribuído na camada anterior, herdado diretamente da tabela de origem."
      - name: product_name
        description: "Nome específico do produto, serviço ou SKU. Mapeado de `aws_product_name` (AWS), `sku` (MongoDB) ou `product_name` (Datadog). Para EKS, é fixado como 'kubernetes'."
      - name: resource_id
        description: "Identificador do recurso específico que incorreu no custo, normalizado de diferentes fontes. ex. o `namespace` para Kubernetes, o `resource_id` para AWS, o `cluster_name` para MongoDB, ou o `service` para Datadog."
      - name: tag_name
        description: "Nome associado ao recurso, derivado de uma tag ou campo de nome. Mapeado de `tag_name` (AWS), `namespace` (EKS), `cluster_name` (MongoDB) ou `service` (Datadog)."
      - name: resource_type
        description: "Tipo de entidade que o `resource_id` representa. É um valor fixo para cada fonte: 'kubernetes_namespace', 'aws_resource_id', 'mongodb_atlas_cluster_name' ou 'datadog_service'."
      - name: total_cost
        description: "Valor monetário total do custo, agregado por todas as dimensões na linha. O cálculo varia por fonte. ex. `SUM(unblended_cost + reservation_cost)` para AWS, `SUM(cost)` para MongoDB/Datadog."
      - name: cost_variation
        description: "Diferença absoluta entre o custo do dia atual e o custo do dia anterior para o mesmo recurso. Calculado como `total_cost - LAG(total_cost, 1)`. Valores positivos indicam aumento de custo, negativos indicam redução. NULL para o primeiro dia de dados de cada recurso."
