version: 2

models:
  - name: aws_costs_drilldown
    meta:
      domain: custos_cloud
      layer: gold
      schema: custos_cloud_gold
      owner: observability-platform@willbank.com.br
      openmetadata:
        tags: ['classificacao_da_informacao.publico']
        tier: 'Tier.Tier2'

    description: |
      **Propósito:** Fornecer uma visão detalhada e unificada dos custos de uso da AWS e do EKS para análises 'drill-down'. A tabela é otimizada para performance em ferramentas de visualização, consolidando dados no nível do recurso individual.
      **Escopo:** Inclui todos os custos de uso da AWS e EKS agregados diariamente por recurso. Para garantir a performance da consulta, os dados são limitados aos últimos 90 dias a partir da data corrente.
      **Audiência:** Engenheiros de FinOps e Tech Leads que precisam realizar análises detalhadas e investigações de custos de recursos específicos em um período recente.
      **Processo:** A query une (`UNION ALL`) duas fontes da camada Silver: `aws_costs_usage` (para custos gerais da AWS) e `aws_eks_costs_usage` (para custos de EKS). Ambas as fontes são pré-filtradas para incluir apenas os últimos 90 dias. Para manter a consistência do esquema, colunas específicas de EKS, como `namespace` e `cluster_name`, são preenchidas com strings vazias para os custos gerais da AWS.
      **Recorrência de atualização:** Diária.

    tags: [gold, will, custos_cloud, drilldown]

    columns:
      - name: start_date
        description: "Data de início do período de uso, truncada para o dia. Apenas os últimos 90 dias são incluídos."
      - name: resource_id
        description: "Identificador do recurso. Mapeado de `resource_id` (para custos AWS) ou `instance_id` (para custos EKS)."
      - name: description
        description: "Descrição do item de linha. Herdado diretamente das fontes `aws_costs_usage` ou `aws_eks_costs_usage`."
      - name: billing_origin
        description: "Origem da cobrança. Herdado diretamente das fontes da camada Silver."
      - name: aws_product_name
        description: "Nome do produto da AWS. Herdado diretamente das fontes da camada Silver."
      - name: namespace
        description: "Namespace do Kubernetes. Preenchido apenas para custos de EKS (fonte `aws_eks_costs_usage`); para outros custos AWS, o campo é uma string vazia."
      - name: cluster_name
        description: "Nome do cluster Kubernetes. Preenchido apenas para custos de EKS (fonte `aws_eks_costs_usage`); para outros custos AWS, o campo é uma string vazia."
      - name: circle_id
        description: "ID do Círculo de custo atribuído na camada Silver."
      - name: providedby_id
        description: "ID do provedor do Círculo. Herdado da camada Silver."
      - name: circle_type
        description: "Tipo do Círculo (ex. 'stream_aligned'). Herdado da camada Silver."
      - name: tag_name
        description: "Valor da tag 'Name' associada ao recurso."
      - name: tag_repository
        description: "Valor da tag 'repository' associada ao recurso."
      - name: tag_product
        description: "Valor da tag 'product' associada ao recurso."
      - name: tag_management
        description: "Valor da tag 'management' associada ao recurso."
      - name: tag_policy_compliant
        description: "Indica se o recurso está em conformidade com a política de tagueamento."
      - name: environment
        description: "Ambiente ao qual o recurso pertence (ex. 'production')."
      - name: account_id
        description: "ID da conta da AWS onde o custo foi incorrido."
      - name: account_name
        description: "Nome da conta da AWS."
      - name: region
        description: "Região da AWS onde o recurso está localizado."
      - name: cost
        description: "Custo total diário agregado. Calculado como `SUM(reservation_cost + unblended_cost)` para custos AWS gerais e `SUM(split_cost + unused_cost)` para custos de EKS."
