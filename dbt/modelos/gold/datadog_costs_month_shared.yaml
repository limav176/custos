version: 2

models:
  - name: datadog_costs_month_shared
    meta:
      domain: custos_cloud
      layer: gold
      schema: custos_cloud_gold
      owner: observability-platform@willbank.com.br
      openmetadata:
        tags: [
          'classificacao_da_informacao.publico'
        ]
        tier: 'Tier.Tier2'

    description: |
      **Propósito:**
      Alocar os custos compartilhados mensais do Datadog entre os Círculos. A alocação é feita de forma proporcional ao consumo direto que cada Círculo faz dos serviços do Datadog, garantindo uma distribuição justa dos custos indiretos.

      **Escopo e Lógica:**
      A tabela implementa uma lógica de rateio proporcional, com uma particularidade importante: o rateio é feito de forma independente para cada tipo de faturamento (`billing_type`).
      - **Fontes de Dados:**
        - `silver.datadog_costs_shared`: Fornece o custo total compartilhado a ser rateado.
        - `gold.datadog_costs_month_usage`: Fornece os custos de uso direto por Círculo, que servem de base para o cálculo do rateio.
      - **Lógica Principal:**
        1. **`month_shared_total`:** Calcula o "bolo" total de custos compartilhados a serem distribuídos, agrupado por mês, produto e `billing_type`.
        2. **Cálculo da Taxa:** Para cada `billing_type` (ex. 'committed', 'on-demand'), a "taxa de participação" (`rate`) de cada Círculo é calculada como `(custo de uso do círculo nesse billing_type) / (custo de uso total nesse billing_type)`.
        3. **Alocação Proporcional:** O custo total compartilhado de um `billing_type` é multiplicado pela `rate` de cada Círculo para determinar a fatia do custo que será alocada.
      - O resultado é uma tabela onde cada linha representa a porção do custo compartilhado de um produto que foi atribuída a um Círculo.

      **Audiência:**
      Engenheiros de FinOps e líderes de Círculos. O resultado desta tabela é consumido pelo modelo `datadog_costs_month` para criar uma visão de custo total (direto + rateado) por time.

      **Processo:**
      A tabela é reconstruída diariamente, aplicando a lógica de rateio.

      **Recorrência:**
      Diária.

    tags: [gold, will, custos_cloud]

    columns:
      - name: start_date
        description: "Primeiro dia do mês de referência do custo. Usado como chave para o rateio."
      - name: origin
        description: "A origem do custo, preenchida estaticamente como 'Datadog'."
      - name: service
        description: "Nome do serviço ou time interno que está recebendo a fatia do custo compartilhado. Herdado de `datadog_costs_month_usage`."
      - name: circle_id
        description: "ID do Círculo (time) que está recebendo a fração do custo compartilhado."
      - name: circle_type
        description: "Tipo do Círculo (ex. 'stream_aligned'). Herdado de `datadog_costs_month_usage`."
      - name: original_product_name
        description: "Nome original do produto compartilhado que está sendo rateado. Proveniente de `datadog_costs_shared`."
      - name: product_name
        description: "Nome do produto. Para custos rateados, este campo é fixado como 'shared'."
      - name: product_group
        description: "Grupo do produto. Para custos rateados, este campo é fixado como 'shared'."
      - name: billing_type
        description: "Tipo de faturamento (ex. 'on-demand'). Usado como chave para o rateio, garantindo que os custos 'committed' sejam rateados apenas com base no uso 'committed'."
      - name: invoice_status
        description: "Status da fatura da qual o custo foi extraído. Herdado de `datadog_costs_month_usage`."
      - name: cost
        description: "Valor monetário da fatia do custo compartilhado alocada ao círculo. Calculado como `custo_total_compartilhado_por_billing_type * taxa_de_uso_do_circulo`."
