version: 2

models:
  - name: circle_month
    meta:
      domain: custos_cloud
      layer: gold
      schema: custos_cloud_gold
      owner: observability-platform@willbank.com.br
      openmetadata:
        tags: [
          'classificacao_da_informacao.publico'
        ]
        tier: 'Tier.Tier2'

    description: |
      **Propósito:**
      Criar uma visão financeira de alto nível que consolida todos os custos mensais por Círculo. A tabela utiliza um formato de "fatura comparativa", apresentando o custo do mês atual e do mês anterior lado a lado para facilitar a análise de variação.

      **Escopo e Lógica:**
      A tabela agrega dados de uma fonte temporária e aplica a lógica de `self-join` para a comparação temporal.
      - **Fonte de Dados:**
        - `gold.circle_temp_2`: Uma tabela intermediária que presumivelmente contém os custos mensais já agregados por `origin`, `circle_id`, e `type`.
      - **Lógica Principal:**
        - A query faz um `FULL OUTER JOIN` da tabela de origem (`month` CTE) com ela mesma.
        - Uma instância representa o "mês atual" (`current_month`) e a outra, o "mês anterior" (`prev_month`).
        - A condição de `JOIN` (`current_month.start_date - interval '1' month = prev_month.start_date`) alinha os registros do mesmo Círculo, Origem e Tipo entre os dois meses.
        - O `FULL OUTER JOIN` e o uso de `COALESCE` garantem que a tabela inclua custos novos ou descontinuados.

      **Audiência:**
      Gestores financeiros e líderes de Círculos. Esta tabela serve como a principal fonte de dados para a tabela `circle_forecast_vs_actual_month` e para relatórios de fechamento que requerem uma visão consolidada dos custos totais por time.

      **Processo:**
      A tabela é reconstruída diariamente, atualizando as comparações mensais com base nos dados da tabela temporária.

      **Recorrência:**
      Diária.

    tags: [gold, will, custos_cloud]

    columns:
      - name: origin
        description: "O provedor de serviço do custo (ex. 'AWS'). O uso de `COALESCE` com `FULL OUTER JOIN` garante que esta chave seja preenchida mesmo que o custo só exista no mês atual ou no anterior."
      - name: circle_id
        description: "O ID do Círculo (time) associado ao custo. O uso de `COALESCE` com `FULL OUTER JOIN` garante que esta chave seja preenchida mesmo que o custo só exista no mês atual ou no anterior."
      - name: type
        description: "A categoria do custo (ex. 'usage', 'platform'). O uso de `COALESCE` com `FULL OUTER JOIN` garante que esta chave seja preenchida mesmo que o custo só exista no mês atual ou no anterior."
      - name: month
        description: "O mês de referência para o `cost` (custo do mês corrente). Calculado a partir de `current_month.start_date` ou inferido como um mês após `prev_month.start_date`."
      - name: cost
        description: "O valor monetário total do custo para o `month`. O `COALESCE` garante que o valor seja `0` se não houver custo no mês corrente."
      - name: previous_month
        description: "O mês de referência para o `previous_cost`. Calculado a partir de `prev_month.start_date` ou inferido como um mês antes de `current_month.start_date`."
      - name: previous_cost
        description: "O valor monetário total do custo para o `previous_month`. O `COALESCE` garante que o valor seja `0` se não havia custo no mês anterior."
