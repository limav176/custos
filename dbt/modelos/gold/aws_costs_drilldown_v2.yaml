version: 2

models:
  - name: aws_costs_drilldown_v2
    meta:
      domain: custos_cloud
      layer: gold
      schema: custos_cloud_gold
      owner: observability-platform@willbank.com.br
      openmetadata:
        tags: ['classificacao_da_informacao.publico']
        tier: 'Tier.Tier2'

    description: |
      **Propósito:** Fornecer uma visão detalhada e unificada dos custos de infraestrutura
      (AWS geral, EKS e Plataforma de Dados) para análises de drill-down. A tabela é
      otimizada para performance em ferramentas de visualização e consolida custos já
      rateados pela Plataforma de Dados junto com custos brutos de AWS/EKS ainda não
      cobertos por Dados.

      **Escopo:** Inclui todos os custos diários de:
      - **Plataforma de Dados** (`gold.data_platform_costs_day_usage`): custos já
        atribuídos a produtos da plataforma (dbt, Looker, ETL custom, sandbox, etc.) e
        a Círculos, filtrados para os últimos 90 dias.
      - **Custos gerais de AWS** (`silver.aws_costs_usage`): custos brutos da AWS para
        recursos que **não** possuem registro correspondente na Plataforma de Dados,
        igualmente limitados aos últimos 90 dias.
      - **Custos de EKS** (`silver.aws_eks_costs_usage`): custos de clusters/namespaces
        EKS que **não** possuem registro correspondente na Plataforma de Dados, também
        limitados aos últimos 90 dias.

      A granularidade é diária por combinação de recurso lógico (`resource_id`), conta,
      região e dimensões de classificação (Círculo, produto, ambiente).

      **Audiência:** Engenheiros de FinOps, time de Plataforma de Dados e Tech Leads que
      precisam:
      - investigar custos de recursos específicos;
      - entender quais parcelas do custo já foram rateadas pela Plataforma de Dados e
        quais continuam como custos brutos de infraestrutura;
      - realizar análises detalhadas em janelas recentes (últimos 90 dias).

      **Processo:**
      - A CTE `data_platform` lê `data_platform_costs_day_usage`, filtra para
        `start_date > current_date - 90`, agrega `SUM(cost)` e `SUM(nr_usage_metric)` e
        projeta o resultado em um esquema de drilldown, com:
          - `start_date` diário;
          - `id_resource` como identificador técnico da infraestrutura (não exposto na
            tabela final);
          - `id_specific_resource` como identificador lógico do produto da plataforma;
          - `description` construída a partir de `nr_usage_metric` e `nm_usage_metric_name`
            (ex.: "123.45 GB data_scanned");
          - `aws_product_name = product_name` (nome amigável do produto/plataforma);
          - `tag_name = id_specific_resource` e tags de repositório/produto/management
            vazias;
          - `nr_datascannedinbytes = SUM(nr_usage_metric)`.
      - As CTEs `aws` e `eks` leem `aws_costs_usage` e `aws_eks_costs_usage`,
        respectivamente, filtradas para os últimos 90 dias. Ambas fazem um `LEFT JOIN`
        com `data_platform` pela composição de `resource_id` + `start_date` e aplicam
        `WHERE d.resource_id IS NULL`, realizando um **left anti join** para não
        duplicar custos já atribuídos na Plataforma de Dados.
          - `aws` agrega `SUM(reservation_cost + unblended_cost)` como `cost`.
          - `eks` agrega `SUM(split_cost + unused_cost)` como `cost`.
          - Em ambas, `nr_datascannedinbytes` é preenchido com `0.0`.
      - O `SELECT` final faz um `UNION ALL` entre:
          - custos brutos de AWS (`aws`);
          - custos brutos de EKS (`eks`);
          - custos de Plataforma de Dados (`data_platform`), onde `resource_id` na saída
            é mapeado para `id_specific_resource` (foco no “recurso lógico” da
            plataforma).

      **Recorrência de atualização:** Diária.

    tags: [gold, will, custos_cloud, drilldown]

    columns:
      - name: start_date
        description: >
          Data de início do período de uso, truncada para o dia.
          Todas as fontes (`data_platform_costs_day_usage`, `aws_costs_usage`,
          `aws_eks_costs_usage`) são filtradas para `start_date > current_date - 90`,
          de forma que a tabela contém apenas os últimos 90 dias.

      - name: resource_id
        description: >
          Identificador do “recurso” em nível de drilldown. A semântica varia conforme
          a origem da linha:
          - Para linhas de **AWS geral** (`aws`), corresponde ao `resource_id` de
            `aws_costs_usage` (recurso físico/lógico da AWS).
          - Para linhas de **EKS** (`eks`), corresponde ao `instance_id` de
            `aws_eks_costs_usage`.
          - Para linhas de **Plataforma de Dados** (`data_platform`), corresponde a
            `id_specific_resource`, isto é, o identificador lógico do produto da
            plataforma (ex.: `dbt/<tabela>`, `looker/<usuario>`, `sandbox/<usuario>`).

          Em todas as origens, `resource_id` é o campo usado para “drill-down” por
          entidade analisada (recurso AWS ou workload da plataforma).

      - name: description
        description: >
          Descrição textual do item de linha.
          - Para linhas de **Plataforma de Dados**, é construída a partir de
            `nr_usage_metric` e `nm_usage_metric_name`, convertendo o valor em KB/MB/GB/TB
            e concatenando com o nome da métrica (ex.: `12.34 GB data_scanned`).
          - Para linhas de **AWS geral** e **EKS**, é herdada diretamente de
            `aws_costs_usage.description` ou `aws_eks_costs_usage.description`.

          Serve como campo legível para explicar “qual uso” originou o custo.

      - name: billing_origin
        description: >
          Origem da cobrança, herdada diretamente das fontes de faturamento:
          - Para linhas de AWS/EKS, vem das tabelas Silver (`aws_costs_usage`,
            `aws_eks_costs_usage`).
          - Para linhas da Plataforma de Dados, vem de `data_platform_costs_day_usage`.

          Permite rastrear qual pipeline/integrador trouxe aquela informação de custo.

      - name: aws_product_name
        description: >
          Nome do produto associado ao custo.
          - Para AWS geral e EKS, é o `aws_product_name` das tabelas Silver
            (ex.: `AmazonEC2`, `Amazon Athena`, `AmazonEKS`).
          - Para Plataforma de Dados, corresponde ao `product_name` de
            `data_platform_costs_day_usage`, representando o produto da plataforma
            (ex.: `DBT (Lake 2)`, `Looker (Athena)`, `Custom ETL (Lake 1)`), ainda que
            a coluna mantenha o nome histórico `aws_product_name` por compatibilidade.

      - name: namespace
        description: >
          Namespace Kubernetes (quando aplicável).
          - Preenchido apenas para linhas originadas de `aws_eks_costs_usage` (EKS),
            refletindo o `namespace` do cluster.
          - Para AWS geral e Plataforma de Dados, é preenchido com string vazia (`''`).

      - name: cluster_name
        description: >
          Nome do cluster Kubernetes (quando aplicável).
          - Preenchido apenas para custos de EKS (fonte `aws_eks_costs_usage`).
          - Para custos gerais de AWS e da Plataforma de Dados, o campo é uma
            string vazia (`''`).

      - name: circle_id
        description: >
          ID do Círculo de custo atribuído.
          - Para linhas da Plataforma de Dados, vem diretamente de
            `data_platform_costs_day_usage.circle_id`.
          - Para AWS/EKS, é herdado de `aws_costs_usage.circle_id` ou
            `aws_eks_costs_usage.circle_id`.

          Permite análises de drill-down por time/fluxo de valor.

      - name: providedby_id
        description: >
          ID do Círculo provedor associado ao custo (por exemplo, círculo de plataforma
          que provê um serviço compartilhado).
          Herdado das respectivas fontes:
          - `providedby_id` em `data_platform_costs_day_usage`, `aws_costs_usage` ou
            `aws_eks_costs_usage`.

      - name: circle_type
        description: >
          Tipo do Círculo (ex.: `stream_aligned`, `platform`, `enabling`), definido
          na camada anterior.
          Herdado diretamente das tabelas de origem (via `circle_type` em
          `data_platform_costs_day_usage`, `aws_costs_usage`, `aws_eks_costs_usage`).

      - name: tag_name
        description: >
          Valor da tag de nome associada ao recurso lógico.
          - Para AWS geral e EKS, corresponde à tag `Name` (ou similar) em
            `aws_costs_usage` e `aws_eks_costs_usage`.
          - Para Plataforma de Dados, é igual a `id_specific_resource`, reforçando a
            identificação do workload da plataforma (ex.: `dbt/<tabela>`,
            `looker/<usuario>`, etc.).

      - name: tag_repository
        description: >
          Valor da tag `repository` associada ao recurso de infraestrutura.
          - Preenchida para AWS/EKS quando a tag está presente nas tabelas Silver.
          - Para linhas da Plataforma de Dados, é sempre string vazia (`''`), pois a
            classificação por repositório é feita indiretamente via `id_specific_resource`
            e metadados da plataforma.

      - name: tag_product
        description: >
          Valor da tag `product` associada ao recurso de infraestrutura na AWS.
          - Herdada das tabelas Silver para AWS geral e EKS.
          - Para Plataforma de Dados, preenchida com string vazia (`''`).

      - name: tag_management
        description: >
          Valor da tag `management` associada ao recurso (por exemplo, indicando
          ownership ou modelo de gestão do recurso).
          - Preenchida para custos de AWS/EKS conforme a camada Silver.
          - Para linhas da Plataforma de Dados, fica como string vazia (`''`).

      - name: tag_policy_compliant
        description: >
          Indica se o recurso está em conformidade com a política de tagueamento.
          - Para AWS geral e EKS, herdado de `aws_costs_usage.tag_policy_compliant` e
            `aws_eks_costs_usage.tag_policy_compliant`.
          - Para Plataforma de Dados, é definido como `TRUE`, assumindo que os custos
            rateados pela plataforma já atenderam aos critérios mínimos de governança.

      - name: environment
        description: >
          Ambiente ao qual o recurso pertence (ex.: `production`, `staging`,
          `development`).
          Herdado das respectivas fontes (`data_platform_costs_day_usage`,
          `aws_costs_usage`, `aws_eks_costs_usage`), permitindo análises de custos
          por ambiente.

      - name: account_id
        description: >
          ID da conta AWS onde o custo foi incorrido.
          - Para AWS geral e EKS, vem diretamente das tabelas Silver.
          - Para Plataforma de Dados, é herdado de `data_platform_costs_day_usage`.
          Em todas as origens, permite consolidar custos por conta.

      - name: account_name
        description: >
          Nome da conta AWS associada ao `account_id`.
          Herdado de todas as fontes e utilizado para facilitar a leitura em relatórios
          e dashboards.

      - name: region
        description: >
          Região AWS onde o recurso está localizado (ex.: `sa-east-1`).
          Herdada de AWS/EKS e da Plataforma de Dados, refletindo a região do
          recurso de infraestrutura associado.

      - name: cost
        description: >
          Custo total diário agregado associado à linha de drilldown.
          - Para **AWS geral**, calculado como `SUM(reservation_cost + unblended_cost)`.
          - Para **EKS**, calculado como `SUM(split_cost + unused_cost)`.
          - Para **Plataforma de Dados**, calculado como `SUM(cost)` em
            `data_platform_costs_day_usage`, já refletindo o custo rateado por produto
            da plataforma/círculo.

          Observação: os custos de AWS/EKS são incluídos apenas quando não existe
          linha correspondente na Plataforma de Dados para o mesmo `resource_id` e
          `start_date`, evitando dupla contagem.

      - name: nr_datascannedinbytes
        description: >
          Quantidade de dados processados (em bytes) associada à métrica de uso da
          Plataforma de Dados, quando aplicável.
          - Para linhas de **Plataforma de Dados**, corresponde ao `SUM(nr_usage_metric)`
            de `data_platform_costs_day_usage` e normalmente representa bytes lidos /
            dados varridos (ex.: em consultas Athena/Trino).
          - Para linhas de **AWS geral** e **EKS**, é preenchido com `0.0`, pois essas
            fontes não expõem essa métrica padronizada.

          Útil para análises de custo por volume de dados processados (ex.: custo por TB
          escaneado).
