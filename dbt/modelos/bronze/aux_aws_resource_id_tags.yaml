version: 2

models:
  - name: aux_aws_resource_id_tags
    meta:
      domain: custos_cloud
      layer: bronze
      schema: custos_cloud_bronze
      owner: observability-platform@willbank.com.br
      openmetadata:
        tags: [
          'classificacao_da_informacao.publico'
        ]
        tier: 'Tier.Tier2'

    description: |
      **Propósito:** Criar uma tabela de dimensão (lookup table) que mapeia cada `resource_id` ao seu conjunto de tags mais recente conhecido, resolvendo o problema de tags que mudam ou estão ausentes em registros de custo históricos.
      **Escopo:** Inclui todos os recursos (`line_item_resource_id`) da tabela de origem que possuem pelo menos uma das seguintes tags preenchidas: `user:product`, `user:repository`, `user:circle_id`, `user:provided_by_id`, `user:management`, ou `user:name`. Recursos sem nenhuma dessas tags são excluídos.
      **Audiência:** Principalmente o modelo de staging `stg_aws_cost_usage_report`, que a utiliza para preencher tags faltantes e garantir uma atribuição de custos consistente ao longo do tempo.
      **Processo:** Derivado da tabela `aws_cost_usage_report`. O processo consiste em: 1. Agrupar os dados por recurso e combinação de tags para encontrar a data mais recente de cada combinação. 2. Filtrar para manter apenas registros onde ao menos uma tag de interesse existe. 3. Encontrar a data de aparição mais recente para cada recurso. 4. Unir os resultados para selecionar o conjunto de tags ativo na última data em que o recurso foi visto.
      **Recorrência de atualização:** Diária (assumindo a recorrência padrão da camada bronze para fontes de custo).

    tags: ['bronze', 'will', 'custos_cloud', 'tags', 'resource', 'mapping', 'latest']

    columns:
      - name: resource_id
        description: "O identificador único do recurso AWS. Derivado da coluna `line_item_resource_id` da fonte `aws_cost_usage_report`."
      - name: tag_product
        description: "A tag de produto (`user:product`) mais recente associada ao recurso. Extraída de `resource_tags_user_product`."
      - name: tag_repository
        description: "A tag de repositório (`user:repository`) mais recente associada ao recurso. Extraída de `resource_tags_user_repository`."
      - name: circle_id
        description: "O ID do círculo (`user:circle_id`) mais recente associado ao recurso. Extraído de `resource_tags_user_circle_id`."
      - name: providedby_id
        description: "O ID do provedor (`user:provided_by_id`) mais recente associado ao recurso. Extraído de `resource_tags_user_provided_by_id`."
      - name: tag_management
        description: "A tag de gerenciamento (`user:management`) mais recente associada ao recurso. Extraída de `resource_tags_user_management`."
      - name: tag_name
        description: "A tag de nome (`user:name`) mais recente associada ao recurso. Extraída de `resource_tags_user_name`."
