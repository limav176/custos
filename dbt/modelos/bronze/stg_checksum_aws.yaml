version: 2

models:
  - name: stg_checksum_aws
    meta:
      domain: custos_cloud
      layer: bronze
      schema: custos_cloud_bronze
      owner: observability-platform@willbank.com.br
      openmetadata:
        tags: [
          'classificacao_da_informacao.publico'
        ]
        tier: 'Tier.Tier2'

    description: >
      **Propósito:** Validar a integridade e a completude dos dados de custo da AWS (checksum). A tabela fornece uma visão agregada mensal dos custos para ser comparada com os totais da fatura da AWS.
      **Escopo:** Inclui custos da AWS, mas exclui explicitamente operações de 'EKSPod-EC2', linhas de 'DiscountedUsage', cobranças de 'AWS Marketplace' e custos do produto 'OCBAWS Brazil 2P' para criar um subtotal consistente e comparável com a fatura principal.
      **Audiência:** Engenheiros de Dados e Analistas de FinOps responsáveis pela conciliação de custos da AWS.
      **Processo:** Os dados são derivados da tabela `sources.custos_cloud_bronze.aws_cost_usage_report`. O modelo trunca a data para o início do mês, agrupa os dados por `circle_id` e nome do produto, e calcula o custo total somando `line_item_unblended_cost` e `reservation_effective_cost`.
      **Recorrência de atualização:** Diária.

    tags: ['bronze', 'will', 'custos_cloud']

    columns:
      - name: start_date
        description: 'Primeiro dia do mês de referência do custo. Calculado truncando a data da coluna `line_item_usage_start_date` para o nível de mês.'
      - name: table_name
        description: 'Nome da tabela de origem dos dados. Valor fixo "aws_cost_usage_report" para identificar a fonte no processo de checksum.'
      - name: circle_id
        description: 'ID do Círculo extraído da tag `resource_tags_user_circle_id`.'
      - name: aws_product_name
        description: 'O nome do produto da AWS ao qual o custo se refere. Copiado diretamente da coluna `product_product_name`.'
      - name: cost
        description: 'Soma do custo total em dólares. Calculado como `SUM(line_item_unblended_cost + reservation_effective_cost)`.'
